<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Join Xperience</title>
    
    <!-- CSS otimizado -->
    <link rel="stylesheet" href="./assets/css/auth-styles.css">
    <link rel="stylesheet" href="./assets/css/forms.css">
    
    <!-- Pré-conexões para melhor performance -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
</head>
<body>
    <header class="main-header">
        <a href="index.html" class="logo-container">
            <img src="./assets/images/JOIN.png" alt="Logo Join Xperience" loading="lazy">
            <span>Join Xperience</span>
        </a>
        <nav>
            <a href="login.html" class="login-link">Já tenho uma conta</a>
        </nav>
    </header>

    <main class="main-container">
        <div class="form-card">
            <h2>Crie sua Conta</h2>
            <form id="cadastro-form" novalidate>
                <div class="profile-selection">
                    <div class="profile-option">
                        <input type="radio" id="aluno" name="perfil" value="aluno" checked>
                        <label for="aluno">Sou Aluno</label>
                    </div>
                    <div class="profile-option">
                        <input type="radio" id="professor" name="perfil" value="professor">
                        <label for="professor">Sou Professor</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="nome">Seu Nome Completo</label>
                    <input type="text" id="nome" required minlength="3">
                </div>

                <div class="form-group">
                    <label for="email">Seu E-mail (será seu login)</label>
                    <input type="email" id="email" required>
                </div>

                <div class="form-group">
                    <label for="senha">Crie uma Senha (mínimo 6 caracteres)</label>
                    <input type="password" id="senha" required minlength="6">
                    <div class="password-strength"></div>
                </div>

                <button type="submit" class="btn btn-secondary">
                    <span class="btn-text">Cadastrar</span>
                    <span class="spinner hidden"></span>
                </button>

                <p class="login-link">Já tem uma conta? <a href="login.html">Faça login</a></p>
            </form>
        </div>
    </main>

    <script type="module">
        // Importações otimizadas
        import { auth, db } from './assets/js/firebase-init.js';
        import { 
            createUserWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { 
            doc, setDoc 
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { 
            validateForm, 
            showAlert,
            toggleButtonState
        } from './assets/js/form-utils.js';

        // Elementos do formulário
        const cadastroForm = document.getElementById("cadastro-form");
        const submitButton = cadastroForm.querySelector('button[type="submit"]');

        // Validação em tempo real
        cadastroForm.addEventListener('input', (e) => {
            validateForm(cadastroForm);
        });

        // Envio do formulário
        cadastroForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            if (!validateForm(cadastroForm)) return;
            
            try {
                toggleButtonState(submitButton, true);
                
                const nome = document.getElementById("nome").value.trim();
                const email = document.getElementById("email").value.trim();
                const senha = document.getElementById("senha").value;
                const perfil = document.querySelector('input[name="perfil"]:checked').value;

                // 1. Cria autenticação
                const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
                const user = userCredential.user;

                // 2. Prepara dados para Firestore
                const userData = {
                    nome: nome,
                    email: email,
                    perfil: perfil,
                    uid: user.uid,
                    criadoEm: new Date().toISOString()
                };
                
                // Dados específicos por perfil
                if (perfil === 'aluno') {
                    userData.turmaId = null;
                    userData.rodadaAtual = 1;
                } else if (perfil === 'professor') {
                    userData.escola = null;
                }

                // 3. Salva no Firestore
                await setDoc(doc(db, "usuarios", user.uid), userData);

                showAlert("Cadastro realizado com sucesso! Redirecionando...", "success");
                setTimeout(() => {
                    window.location.href = perfil === 'aluno' ? 'aluno/dashboard.html' : 'professor.html';
                }, 1500);

            } catch (error) {
                console.error("Erro no cadastro:", error);
                handleAuthError(error);
                toggleButtonState(submitButton, false);
            }
        });

        // Tratamento de erros
        function handleAuthError(error) {
            const errorMessages = {
                'auth/email-already-in-use': 'Este e-mail já está cadastrado.',
                'auth/weak-password': 'A senha deve ter pelo menos 6 caracteres.',
                'auth/invalid-email': 'Por favor, insira um e-mail válido.',
                'auth/operation-not-allowed': 'Operação não permitida.',
                'auth/network-request-failed': 'Erro de conexão. Verifique sua internet.'
            };

            const message = errorMessages[error.code] || 'Ocorreu um erro durante o cadastro.';
            showAlert(message, "error");
        }
    </script>
</body>
</html>