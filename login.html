// Adicione um 'event listener' ao formulário de login
document.getElementById('login-form').addEventListener('submit', function(event) {
    event.preventDefault(); // Impede o recarregamento da página

    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const errorMessage = document.getElementById('error-message');

    // Autenticar com o Firebase
    firebase.auth().signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // O login foi bem-sucedido, agora vamos buscar os dados do utilizador no Firestore
            const user = userCredential.user;
            
            // Referência ao documento do utilizador no Firestore
            const userDocRef = firebase.firestore().collection('users').doc(user.uid);

            userDocRef.get().then((doc) => {
                if (doc.exists) {
                    // O documento do utilizador foi encontrado
                    const userData = doc.data();

                    // --- INÍCIO DA LÓGICA DE REDIRECIONAMENTO ---

                    if (userData.profile === 'professor') {
                        // 1. Se o perfil for 'professor', redireciona para a página do professor
                        console.log('Utilizador é um professor. Redirecionando...');
                        window.location.href = 'professor/professor.html'; // Ajuste o caminho se necessário

                    } else if (userData.profile === 'aluno') {
                        // 2. Se o perfil for 'aluno', verifica se ele tem uma turma
                        console.log('Utilizador é um aluno. Verificando turma...');
                        
                        if (userData.turmaId) {
                            // 2.1. Aluno JÁ TEM uma turma.
                            // Lógica futura: redirecionar para a rodada correta.
                            // Por agora, podemos redirecioná-lo para uma página padrão de jogo.
                            console.log('Aluno tem turmaId. Redirecionando para o jogo...');
                            // Exemplo: window.location.href = `aluno/rodada${userData.rodadaAtual}.html`;
                            window.location.href = 'aluno/dashboard.html'; // Crie uma página de dashboard ou rodada inicial

                        } else {
                            // 2.2. Aluno NÃO TEM uma turma. Redireciona para a sala de espera.
                            console.log('Aluno sem turmaId. Redirecionando para a sala de espera...');
                            window.location.href = 'aluno/xperience.html'; // A PÁGINA DE ESPERA CORRETA
                        }
                    } else {
                        // Caso o perfil não seja nem 'aluno' nem 'professor'
                        errorMessage.textContent = 'Perfil de utilizador desconhecido.';
                        firebase.auth().signOut(); // Desconecta para segurança
                    }
                    // --- FIM DA LÓGICA DE REDIRECIONAMENTO ---

                } else {
                    // Erro crítico: utilizador autenticado mas sem dados no Firestore
                    errorMessage.textContent = 'Erro: Não foi possível encontrar os dados do utilizador.';
                    firebase.auth().signOut();
                }
            }).catch((error) => {
                errorMessage.textContent = 'Erro ao aceder à base de dados: ' + error.message;
                firebase.auth().signOut();
            });
        })
        .catch((error) => {
            // Trata erros de login (senha errada, utilizador não encontrado, etc.)
            errorMessage.textContent = 'Email ou senha inválidos. Por favor, tente novamente.';
            console.error('Erro de login:', error);
        });
});