<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerir Turmas - Join Xperience</title>
    
    <!-- CSS otimizado -->
    <link rel="stylesheet" href="../assets/css/professor-styles.css">
    <link rel="stylesheet" href="../assets/css/turmas.css">
    
    <!-- Pré-conexões para melhor performance -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
</head>
<body class="flex-body">
    <header class="main-header">
        <a href="../index.html" class="logo-container">
            <img src="../assets/images/JOIN.png" alt="Logo Join Xperience" loading="lazy">
            <span>Join Xperience</span>
        </a>
        <nav>
            <button id="logout-button" class="btn-logout">Sair</button>
        </nav>
    </header>

    <main class="container">
        <div class="page-header">
            <h1>Gestão de Turmas</h1>
            <button id="open-create-turma-modal" class="btn btn-success">Criar Nova Turma</button>
        </div>
        <div id="turmas-grid" class="turmas-grid">
            <p id="loading-message">A verificar autenticação...</p>
        </div>
    </main>

    <footer class="main-footer">
        <p>© <span id="current-year">2025</span> JOIN XPERIENCE - Todos os direitos reservados</p>
    </footer>

    <!-- Modals -->
    <div id="create-turma-modal" class="modal-backdrop" aria-hidden="true">
        <!-- Conteúdo do modal mantido -->
    </div>

    <div id="manage-students-modal" class="modal-backdrop" aria-hidden="true">
        <!-- Conteúdo do modal mantido -->
    </div>

    <div id="qrcode-modal" class="modal-backdrop" aria-hidden="true">
        <!-- Conteúdo do modal mantido -->
    </div>

    <!-- Scripts otimizados -->
    <script type="module">
        // Importações otimizadas
        import { auth, db } from '../assets/js/firebase-init.js';
        import { 
            collection, addDoc, serverTimestamp, 
            query, where, getDocs, doc, 
            updateDoc, arrayUnion, getDoc, writeBatch 
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { showAlert, validateForm } from '../assets/js/form-utils.js';
        import { generateJoinCode } from '../assets/js/utils.js';
        import QRCode from 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';

        // --- CONSTANTES ---
        const RODADA_STATUS = {
            NAO_INICIADA: 'nao_iniciada',
            INICIADA: 'iniciada',
            FINALIZADA: 'finalizada'
        };

        // --- VARIÁVEIS GLOBAIS ---
        let currentUser = null;
        let currentTurmaId = null;

        // --- ELEMENTOS DO DOM ---
        const turmasGrid = document.getElementById('turmas-grid');
        const createTurmaModal = document.getElementById('create-turma-modal');
        const manageStudentsModal = document.getElementById('manage-students-modal');
        const qrcodeModal = document.getElementById('qrcode-modal');

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            initModals();
            initForms();
            document.getElementById('current-year').textContent = new Date().getFullYear();
        });

        // --- AUTENTICAÇÃO ---
        function initAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user && user.email.endsWith('@escola.com')) {
                    document.body.style.display = 'flex';
                    currentUser = user;
                    await loadTurmas();
                } else {
                    window.location.href = '../login.html';
                }
            });

            document.getElementById('logout-button').addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await signOut(auth);
                    window.location.href = '../login.html';
                } catch (error) {
                    console.error('Erro ao fazer logout:', error);
                    showAlert('Ocorreu um erro ao tentar sair.', 'error');
                }
            });
        }

        // --- MODAIS ---
        function initModals() {
            // Fechar modais
            document.querySelectorAll('.close-button').forEach(btn => {
                btn.addEventListener('click', closeAllModals);
            });

            // Abrir modal de criação
            document.getElementById('open-create-turma-modal').addEventListener('click', () => {
                createTurmaModal.style.display = 'flex';
                document.getElementById('turma-name').focus();
            });

            // Delegar eventos na grade de turmas
            turmasGrid.addEventListener('click', handleTurmaCardClick);
        }

        // --- FORMULÁRIOS ---
        function initForms() {
            // Formulário de criação de turma
            document.getElementById('create-turma-form').addEventListener('submit', handleCreateTurma);

            // Formulário de adição de aluno
            document.getElementById('add-student-form').addEventListener('submit', handleAddStudent);
        }

        // --- LÓGICA DE TURMAS ---
        async function loadTurmas() {
            if (!currentUser) return;
            
            turmasGrid.innerHTML = '<p id="loading-message">A carregar turmas...</p>';
            
            try {
                const q = query(collection(db, "turmas"), where("professorId", "==", currentUser.uid));
                const querySnapshot = await getDocs(q);
                
                turmasGrid.innerHTML = '';
                
                if (querySnapshot.empty) {
                    turmasGrid.innerHTML = '<p id="no-turmas-message">Nenhuma turma criada ainda. Clique em "Criar Nova Turma" para começar.</p>';
                    return;
                }

                querySnapshot.forEach((docRef) => {
                    renderTurmaCard(docRef.id, docRef.data());
                });
            } catch (error) {
                console.error("Erro ao carregar turmas:", error);
                showAlert('Ocorreu um erro ao carregar as turmas.', 'error');
                turmasGrid.innerHTML = '<p id="error-message">Ocorreu um erro ao carregar as turmas.</p>';
            }
        }

        function renderTurmaCard(turmaId, turma) {
            const card = document.createElement('div');
            card.className = 'turma-card';
            card.dataset.turmaId = turmaId;
            card.dataset.turmaName = turma.nome;
            card.dataset.turmaCode = turma.codigo;

            const rodadaAtual = turma.rodadaAtual || 1;
            const status = turma[`statusRodada${rodadaAtual}`] || RODADA_STATUS.NAO_INICIADA;
            
            card.innerHTML = `
                <div class="turma-card-header"><h3>${turma.nome}</h3></div>
                <div class="turma-card-body">
                    <p>Alunos inscritos: ${turma.alunos?.length || 0}</p>
                    <div class="turma-code" title="Clique para ver o QR Code">${turma.codigo || 'N/D'}</div>
                    <p style="margin-top: 20px;"><strong>Status da Rodada ${rodadaAtual}:</strong></p>
                    <div class="round-status status-${status}">${status.replace('_', ' ').toUpperCase()}</div>
                </div>
                <div class="turma-card-footer">
                    ${getRoundButton(status, rodadaAtual)}
                    <button class="btn btn-primary btn-sm manage-students-btn">Gerir Alunos</button>
                </div>`;
                
            turmasGrid.appendChild(card);
        }

        function getRoundButton(status, rodadaAtual) {
            if (status === RODADA_STATUS.NAO_INICIADA) {
                return `<button class="btn btn-success start-round-btn" data-round="${rodadaAtual}">Iniciar Rodada ${rodadaAtual}</button>`;
            } 
            if (status === RODADA_STATUS.INICIADA) {
                return `<button class="btn btn-warning end-round-btn" data-round="${rodadaAtual}">Finalizar Rodada ${rodadaAtual}</button>`;
            }
            // Se finalizada, mostra botão para próxima rodada
            return `<button class="btn btn-success start-round-btn" data-round="${rodadaAtual + 1}">Iniciar Rodada ${rodadaAtual + 1}</button>`;
        }

        // --- HANDLERS DE EVENTOS ---
        async function handleTurmaCardClick(e) {
            const card = e.target.closest('.turma-card');
            if (!card) return;

            const turmaId = card.dataset.turmaId;
            const turmaName = card.dataset.turmaName;
            const turmaCode = card.dataset.turmaCode;
            currentTurmaId = turmaId;

            if (e.target.classList.contains('manage-students-btn')) {
                await openManageStudentsModal(turmaId, turmaName);
            } 
            else if (e.target.classList.contains('turma-code')) {
                openQrCodeModal(turmaCode, turmaName);
            }
            else if (e.target.classList.contains('start-round-btn')) {
                const roundToStart = e.target.dataset.round;
                if (confirm(`Iniciar Rodada ${roundToStart} para "${turmaName}"?`)) {
                    await updateRoundStatus(turmaId, roundToStart, RODADA_STATUS.INICIADA);
                }
            }
            else if (e.target.classList.contains('end-round-btn')) {
                const roundToEnd = e.target.dataset.round;
                if (confirm(`Finalizar Rodada ${roundToEnd} para "${turmaName}"?`)) {
                    await updateRoundStatus(turmaId, roundToEnd, RODADA_STATUS.FINALIZADA);
                }
            }
        }

        async function handleCreateTurma(e) {
            e.preventDefault();
            const turmaName = document.getElementById('turma-name').value.trim();
            
            if (!turmaName || !currentUser) return;

            try {
                await addDoc(collection(db, "turmas"), {
                    nome: turmaName,
                    professorId: currentUser.uid,
                    codigo: generateJoinCode(),
                    criadoEm: serverTimestamp(),
                    alunos: [],
                    rodadaAtual: 1,
                    statusRodada1: RODADA_STATUS.NAO_INICIADA,
                });
                
                closeAllModals();
                document.getElementById('create-turma-form').reset();
                await loadTurmas();
                showAlert('Turma criada com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao criar turma:", error);
                showAlert('Não foi possível criar a turma.', 'error');
            }
        }

        // ... (outros handlers mantidos com a mesma estrutura)

        // --- FUNÇÕES AUXILIARES ---
        function closeAllModals() {
            document.querySelectorAll('.modal-backdrop').forEach(modal => {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            });
        }

        function showAlert(message, type = 'info') {
            // Implementação da função de alerta
        }

        // ... (outras funções auxiliares)

    </script>
</body>
</html>