<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugerir Cenários - Join Xperience</title>
    
    <!-- CSS otimizado -->
    <link rel="stylesheet" href="../css/professor-styles.css">
    <link rel="stylesheet" href="../css/modal-forms.css">
    
    <!-- Pré-conexões para melhor performance -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://formspree.io">
</head>
<body class="flex-body">
    <header class="main-header">
        <a href="../index.html" class="logo-container">
            <img src="../JOIN.png" alt="Logo Join Xperience" loading="lazy">
            <span>Join Xperience</span>
        </a>
        <nav>
            <button id="logout-button" class="btn-logout">Sair</button>
        </nav>
    </header>

    <main class="container">
        <div class="page-header">
            <h1>Sugestão de Cenários</h1>
            <div class="button-group">
                <a href="professor.html" class="btn btn-primary">Voltar ao Painel</a>
                <button id="suggest-scenario-button" class="btn btn-success">Sugerir Novo Cenário</button>
            </div>
        </div>

        <div class="placeholder-text">
            <p>Tem uma ideia para um novo cenário de simulação? <br>Clique no botão abaixo e compartilhe sua ideia conosco!</p>
        </div>
    </main>

    <footer class="main-footer">
        <p>© <span id="current-year">2025</span> JOIN XPERIENCE - Todos os direitos reservados</p>
    </footer>

    <!-- Modal de Sugestão -->
    <div id="scenario-modal" class="modal-backdrop" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <div class="modal-header">
                <h2 id="modal-title">Sugerir Novo Cenário</h2>
                <button class="close-button" aria-label="Fechar modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="suggest-scenario-form" novalidate>
                    <div class="form-group">
                        <label for="scenario-name">Nome da Ideia / Cenário</label>
                        <input type="text" id="scenario-name" name="nome_cenario" required
                               aria-required="true" minlength="5" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="scenario-description">Descrição da Sugestão</label>
                        <textarea id="scenario-description" name="descricao" required rows="6"
                                  aria-required="true" minlength="20" maxlength="1000"></textarea>
                    </div>
                    <div id="form-status" role="alert"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-button">Cancelar</button>
                <button type="submit" form="suggest-scenario-form" class="btn btn-success">Enviar Sugestão</button>
            </div>
        </div>
    </div>

    <!-- Scripts otimizados -->
    <script type="module">
        // Importações otimizadas
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { auth } from '../js/firebase-init.js';
        import { validateForm, showAlert } from '../js/form-utils.js';

        // Verificação de autenticação
        onAuthStateChanged(auth, (user) => {
            if (!user || !user.email.endsWith('@escola.com')) {
                window.location.href = '../sitejoin/login.html';
            } else {
                document.body.style.display = 'flex';
            }
        });

        // Configuração do modal
        const modal = document.getElementById('scenario-modal');
        const form = document.getElementById('suggest-scenario-form');
        const statusDiv = document.getElementById('form-status');
        
        // Gerenciamento do modal
        const setupModal = () => {
            document.getElementById('suggest-scenario-button').addEventListener('click', openModal);
            document.querySelector('.close-button').addEventListener('click', closeModal);
            document.getElementById('cancel-button').addEventListener('click', closeModal);
            
            window.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });

            window.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') closeModal();
            });
        };

        const openModal = () => {
            form.reset();
            statusDiv.innerHTML = '';
            modal.setAttribute('aria-hidden', 'false');
            modal.style.display = 'block';
            document.getElementById('scenario-name').focus();
        };

        const closeModal = () => {
            modal.setAttribute('aria-hidden', 'true');
            modal.style.display = 'none';
        };

        // Envio do formulário
        const handleSubmit = async (event) => {
            event.preventDefault();
            
            if (!validateForm(form)) return;
            
            try {
                const response = await fetch("https://formspree.io/f/xblyklbk", {
                    method: 'POST',
                    body: new FormData(form),
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    showAlert(statusDiv, "Obrigado pela sua sugestão!", 'success');
                    setTimeout(closeModal, 2000);
                } else {
                    const data = await response.json();
                    const errorMsg = data.errors?.map(e => e.message).join(", ") || 
                                   "Oops! Houve um problema ao enviar seu formulário.";
                    showAlert(statusDiv, errorMsg, 'error');
                }
            } catch (error) {
                showAlert(statusDiv, "Erro de conexão. Tente novamente mais tarde.", 'error');
                console.error('Submission error:', error);
            }
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            setupModal();
            form.addEventListener('submit', handleSubmit);
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // Logout seguro
            document.getElementById('logout-button').addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await signOut(auth);
                    window.location.href = '../index.html';
                } catch (error) {
                    console.error('Erro ao fazer logout:', error);
                    alert('Ocorreu um erro ao tentar sair. Por favor, tente novamente.');
                }
            });
        });
    </script>
</body>
</html>