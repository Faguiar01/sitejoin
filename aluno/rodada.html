<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rodada Atual - Join Xperience</title>
    <style>
        :root { --cor-primaria: #0052CC; --cor-sucesso: #28a745; --cor-perigo: #dc3545; --cor-texto: #333; --cor-fundo: #f4f7f6; --cor-branco: #fff; --cor-cinza-escuro: #343a40; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--cor-fundo); display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; width: 100%; box-sizing: border-box; }
        header.main-header { background-color: var(--cor-branco); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        header.main-header .logo-container { display: flex; align-items: center; text-decoration: none; color: var(--cor-texto); font-weight: 600; }
        header.main-header .logo-container img { height: 50px; margin-right: 15px; }
        header.main-header nav a { color: var(--cor-primaria); text-decoration: none; font-weight: 500; padding: 8px 16px; border: 1px solid var(--cor-primaria); border-radius: 8px; }
        main { flex: 1; }
        .page-header { padding: 20px; text-align: center; border-bottom: 1px solid #ddd; background-color: #e9ecef; }
        .page-header h1 { margin: 0; font-size: 2.2em; }
        .page-header p { margin: 10px 0 0 0; font-size: 1.1em; color: #555; }
        .progress-bar-container { width: 100%; background-color: #e0e0e0; border-radius: 10px; margin-top: 20px; overflow: hidden; }
        .progress-bar { width: 20%; height: 10px; background-color: var(--cor-sucesso); border-radius: 10px; transition: width 0.4s ease; }
        .round-view, .activity-step { display: none; }
        .round-view.active, .activity-step.active { display: block; animation: fadeIn 0.5s; }
        .activity-block { background-color: var(--cor-branco); margin-top: 20px; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .activity-block h3 { font-size: 1.5em; margin-top: 0; border-bottom: 2px solid var(--cor-primaria); padding-bottom: 10px; }
        .question-text { font-size: 1.1em; line-height: 1.6; margin-bottom: 15px; }
        .activity-block label { display: block; background-color: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; }
        .activity-block textarea { width: 100%; min-height: 100px; padding: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; resize: vertical; }
        .column-matching { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
        .column { flex: 1; min-width: 250px; }
        .column ol { padding-left: 20px; }
        .column select { width: 100%; padding: 10px; margin-top: 5px; }
        .case-study-box { background-color: #e9f2ff; border-left: 5px solid var(--cor-primaria); padding: 20px; margin-bottom: 20px; border-radius: 5px; }
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 40px; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; text-decoration: none; font-weight: 700; font-size: 1.1em; cursor: pointer; }
        .btn-secondary { background-color: #6c757d; color: var(--cor-branco); }
        .btn-primary { background-color: var(--cor-primaria); color: var(--cor-branco); }
        .btn-success { background-color: var(--cor-sucesso); color: var(--cor-branco); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn:hover:not(:disabled) { opacity: 0.85; }
        .status-message { text-align: center; padding: 40px; background-color: var(--cor-branco); border-radius: 8px; margin-top: 30px; }
        .feedback-item { margin-bottom: 15px; padding: 15px; border-radius: 8px; }
        .feedback-item.correct { background-color: #e8f5e9; border-left: 5px solid var(--cor-sucesso); }
        .feedback-item.incorrect { background-color: #ffebee; border-left: 5px solid var(--cor-perigo); }
        .score-summary { text-align: center; font-size: 1.5em; font-weight: bold; margin-bottom: 30px; }
        .balance-sheet-form .form-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .balance-sheet-form .form-grid { grid-template-columns: 1fr 1fr; } }
        .balance-sheet-form .form-group { margin-bottom: 15px; }
        .balance-sheet-form label { display: block; margin-bottom: 5px; font-weight: 600; }
        .balance-sheet-form input { width: 100%; padding: 10px; font-size: 1.1em; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        .summary-box { margin-top: 30px; padding: 20px; background-color: #e9ecef; border-radius: 8px; }
        .summary-box p { display: flex; justify-content: space-between; font-size: 1.2em; margin: 10px 0; }
        .summary-box span { font-weight: bold; }
        #saldo-alocar.unbalanced { color: var(--cor-perigo); }
        #saldo-alocar.balanced { color: var(--cor-sucesso); }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        footer.main-footer { background-color: var(--cor-cinza-escuro); color: var(--cor-branco); padding: 20px; text-align: center; margin-top: auto; }
    </style>
</head>
<body>
    <header class="main-header"><a href="xperience.html" class="logo-container"><img src="../JOIN.png" alt="Logo Join Xperience"><span>Join Xperience</span></a><nav><a href="#" id="logout-button">Sair</a></nav></header>
    <main class="container">
        <div id="status-view"><div class="status-message"><h2>Verificando status da rodada...</h2></div></div>
        <div id="round-1-view" class="round-view">
            <div class="page-header"><h1>Rodada 1: Nivelamento de Conhecimento</h1><p id="progress-text">Etapa 1 de 5</p><div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div></div>
            <form id="round1-form"><div id="step-1" class="activity-step active"><div class="activity-block"><h3>Atividade 1: Múltipla Escolha</h3><p class="question-text">1. Qual destes itens NÃO faz parte da estrutura de um Demonstrativo de Resultado do Exercício (DRE)?</p><label><input type="radio" name="q1" value="a" required> Receita de Vendas</label><label><input type="radio" name="q1" value="b" required> Custo da Mercadoria Vendida (CMV)</label><label><input type="radio" name="q1" value="c" required> Dinheiro em Caixa</label><label><input type="radio" name="q1" value="d" required> Despesas Operacionais</label><p class="question-text" style="margin-top:25px;">2. Uma empresa pegou um empréstimo de R$1.000,00 com juros de 10% ao mês. No regime de **Juros Compostos**, qual o valor total a ser pago (principal + juros) após 2 meses?</p><label><input type="radio" name="q2" value="a"> R$ 1.200,00</label><label><input type="radio" name="q2" value="b"> R$ 1.210,00</label><label><input type="radio" name="q2" value="c"> R$ 1.100,00</label><p class="question-text" style="margin-top:25px;">3. O Imposto sobre Serviços (ISS) é de competência:</p><label><input type="radio" name="q3" value="a"> Federal</label><label><input type="radio" name="q3" value="b"> Estadual</label><label><input type="radio" name="q3" value="c"> Municipal</label></div></div><div id="step-2" class="activity-step"><div class="activity-block"><h3>Atividade 2: Relacione as Colunas</h3><div class="column-matching"><div class="column"><p><strong>Coluna A (Itens)</strong></p><ol><li>Fornecedores a Pagar</li><li>Estoque de Produtos</li><li>Máquinas e Equipamentos</li><li>Capital Social</li><li>Contas a Receber</li></ol></div><div class="column"><p><strong>Coluna B (Classificação)</strong></p><label>1.</label> <select name="q_match_1" required><option value="">Selecione...</option><option value="passivo">Passivo</option><option value="ativo">Ativo</option><option value="pl">Patrimônio Líquido</option></select><label>2.</label> <select name="q_match_2" required><option value="">Selecione...</option><option value="passivo">Passivo</option><option value="ativo">Ativo</option><option value="pl">Patrimônio Líquido</option></select><label>3.</label> <select name="q_match_3" required><option value="">Selecione...</option><option value="passivo">Passivo</option><option value="ativo">Ativo</option><option value="pl">Patrimônio Líquido</option></select><label>4.</label> <select name="q_match_4" required><option value="">Selecione...</option><option value="passivo">Passivo</option><option value="ativo">Ativo</option><option value="pl">Patrimônio Líquido</option></select><label>5.</label> <select name="q_match_5" required><option value="">Selecione...</option><option value="passivo">Passivo</option><option value="ativo">Ativo</option><option value="pl">Patrimônio Líquido</option></select></div></div></div></div><div id="step-3" class="activity-step"><div class="activity-block"><h3>Atividade 3: Verdadeiro ou Falso</h3><p class="question-text">1. Afirmação: "Lucro e Caixa são sinônimos. Se uma empresa teve lucro, significa que seu dinheiro em caixa aumentou na mesma proporção."</p><label><input type="radio" name="q_vf_1" value="true" required> Verdadeiro</label><label><input type="radio" name="q_vf_1" value="false" required> Falso</label><p class="question-text" style="margin-top:25px;">2. Afirmação: "Depreciação de uma máquina é uma despesa que não representa uma saída de dinheiro do caixa no período em que ocorre."</p><label><input type="radio" name="q_vf_2" value="true" required> Verdadeiro</label><label><input type="radio" name="q_vf_2" value="false" required> Falso</label></div></div><div id="step-4" class="activity-step"><div class="activity-block"><h3>Atividade 4: Ordene as Etapas</h3><p>Ordene as etapas do processo de Contas a Pagar de uma empresa.</p><label>Etapa 1: <select name="q_order_1" required><option value="">Selecione...</option><option value="pagar">Pagar o boleto no vencimento</option><option value="receber">Receber a nota fiscal do fornecedor</option><option value="lancar">Lançar a conta a pagar no sistema</option><option value="conferir">Conferir a mercadoria recebida</option></select></label><label>Etapa 2: <select name="q_order_2" required><option value="">Selecione...</option><option value="pagar">Pagar o boleto no vencimento</option><option value="receber">Receber a nota fiscal do fornecedor</option><option value="lancar">Lançar a conta a pagar no sistema</option><option value="conferir">Conferir a mercadoria recebida</option></select></label><label>Etapa 3: <select name="q_order_3" required><option value="">Selecione...</option><option value="pagar">Pagar o boleto no vencimento</option><option value="receber">Receber a nota fiscal do fornecedor</option><option value="lancar">Lançar a conta a pagar no sistema</option><option value="conferir">Conferir a mercadoria recebida</option></select></label><label>Etapa 4: <select name="q_order_4" required><option value="">Selecione...</option><option value="pagar">Pagar o boleto no vencimento</option><option value="receber">Receber a nota fiscal do fornecedor</option><option value="lancar">Lançar a conta a pagar no sistema</option><option value="conferir">Conferir a mercadoria recebida</option></select></label></div></div><div id="step-5" class="activity-step"><div class="activity-block"><h3>Atividade 5: Estudo de Caso</h3><div class="case-study-box"><p><strong>O Pedido Urgente da "TecnoCorp"</strong></p><p>A "InovaPlas" fechou um pedido de R$ 80.000,00, mas o prazo de entrega é curtíssimo. Para cumprir, será preciso comprar matéria-prima de um fornecedor alternativo que cobra 20% mais caro e exige pagamento à vista.</p></div><p class="question-text">1. Qual seria o impacto imediato no Fluxo de Caixa da InovaPlas? Justifique.</p><textarea name="q_case_1" rows="4" required></textarea><p class="question-text" style="margin-top:20px;">2. Qual o impacto que a compra deste material mais caro terá sobre a margem de lucro deste pedido?</p><textarea name="q_case_2" rows="4" required></textarea></div></div>
                <div class="navigation-buttons"><button type="button" id="prev-btn" class="btn btn-secondary">Anterior</button><button type="button" id="next-btn" class="btn btn-primary">Próxima Atividade</button><button type="submit" id="submit-btn" class="btn btn-success" style="display: none;">Finalizar e Enviar Rodada 1</button></div>
            </form>
        </div>
        <div id="results-view" class="round-view"><div class="page-header"><h1>Resultados da Rodada 1</h1></div><div class="activity-block"><p id="score-summary" class="score-summary"></p><div id="detailed-feedback"></div><div style="text-align:center; margin-top: 30px;"><a href="xperience.html" class="btn btn-primary">Voltar ao Painel do Aluno</a></div></div></div>
        <div id="round-2-view" class="round-view"><div class="page-header"><h1>Rodada 2: Estruturação da Empresa</h1><p>Alouque o capital inicial da sua empresa para definir a estrutura financeira.</p></div><div class="activity-block"><h3>Balanço Patrimonial de Abertura</h3><form id="round-2-form" class="balance-sheet-form"><div class="form-grid"><div><h4>Fontes de Recursos (Passivo + PL)</h4><div class="form-group"><label>Capital Social (Fixo)</label><input type="text" id="r2-capital" value="R$ 480.000,00" disabled></div><div class="form-group"><label for="r2-emprestimo">Empréstimo Bancário (Opcional)</label><input type="number" id="r2-emprestimo" name="emprestimo" min="0" value="0"></div></div><div><h4>Alocação de Recursos (Ativos)</h4><div class="form-group"><label for="r2-caixa">Caixa</label><input type="number" id="r2-caixa" name="caixa" min="0" value="0" required></div><div class="form-group"><label for="r2-estoques">Estoques</label><input type="number" id="r2-estoques" name="estoques" min="0" value="0" required></div><div class="form-group"><label for="r2-imoveis">Imóveis</label><input type="number" id="r2-imoveis" name="imoveis" min="0" value="0" required></div><div class="form-group"><label for="r2-maquinas">Máquinas e Equipamentos</label><input type="number" id="r2-maquinas" name="maquinas" min="0" value="0" required></div><div class="form-group"><label for="r2-veiculos">Veículos</label><input type="number" id="r2-veiculos" name="veiculos" min="0" value="0" required></div></div></div><div class="summary-box"><p>Total de Recursos (Capital + Empréstimo): <span id="total-recursos">R$ 480.000,00</span></p><p>Total Alocado em Ativos: <span id="total-alocado">R$ 0,00</span></p><hr><p><strong>Saldo a Alocar:</strong> <span id="saldo-alocar" class="unbalanced">R$ 480.000,00</span></p></div><div style="text-align:center; margin-top: 30px;"><button type="submit" id="r2-submit-btn" class="btn btn-success" disabled>Finalizar Estruturação</button></div></form></div></div>
    </main>
    <footer class="main-footer"><p>© 2025 JOIN XPERIENCE - Todos os direitos reservados</p></footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAXtFYlnq57POCOp-b4TFuYucGlbn4NkAk", authDomain: "joinxperience-site.firebaseapp.com", projectId: "joinxperience-site", storageBucket: "joinxperience-site.appspot.com", messagingSenderId: "140037739806", appId: "1:140037739806:web:322493d72ca6149abce50f", measurementId: "G-V4SRK0FNBN" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.getElementById('logout-button').addEventListener('click', (e) => { e.preventDefault(); signOut(auth).then(() => { window.location.href = '../index.html'; }); });

        const statusView = document.getElementById('status-view');
        const round1View = document.getElementById('round-1-view');
        const round2View = document.getElementById('round-2-view');
        const resultsView = document.getElementById('results-view');
        const answerKeyR1 = { q1: 'c', q2: 'b', q3: 'c', q_match_1: 'passivo', q_match_2: 'ativo', q_match_3: 'ativo', q_match_4: 'pl', q_match_5: 'ativo', q_vf_1: 'false', q_vf_2: 'true', q_order_1: 'b', q_order_2: 'd', q_order_3: 'c', q_order_4: 'a' };

        onAuthStateChanged(auth, (user) => { if (user) { checkRoundStatus(user); } else { window.location.href = '../login.html'; } });

        async function checkRoundStatus(user) {
            statusView.style.display = 'block';
            [round1View, round2View, resultsView].forEach(v => v.style.display = 'none');
            try {
                const turmasRef = collection(db, "turmas");
                const q = query(turmasRef, where("alunos", "array-contains", user.uid), limit(1));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { statusView.innerHTML = `<div class="status-message"><h2>Você não está em uma turma.</h2><p>Volte ao painel e insira o código.</p><br/><a href="xperience.html" class="btn btn-primary">Voltar</a></div>`; return; }

                const turmaData = querySnapshot.docs[0].data();

                if (turmaData.rodadaAtual === 1) {
                    const respostaRef = doc(db, "respostas_rodadas", `rodada1_${user.uid}`);
                    const respostaSnap = await getDoc(respostaRef);
                    if (respostaSnap.exists()) {
                        statusView.style.display = 'none';
                        displayResults(respostaSnap.data().respostas, respostaSnap.data().pontuacao);
                    } else if (turmaData.statusRodada1 === 'iniciada') {
                        statusView.style.display = 'none';
                        round1View.style.display = 'block';
                        initializeQuizR1();
                    } else {
                        statusView.innerHTML = `<div class="status-message"><h2>Rodada 1: Aguardando Início</h2><p>Seu professor ainda não iniciou esta rodada.</p><br/><a href="xperience.html" class="btn btn-primary">Voltar</a></div>`;
                    }
                } else if (turmaData.rodadaAtual === 2) {
                    // Lógica para rodada 2
                    statusView.style.display = 'none';
                    round2View.style.display = 'block';
                    initializeRound2();
                }

            } catch (error) { console.error("Erro: ", error); statusView.innerHTML = `<div class="status-message"><h2>Ocorreu um Erro</h2><p>Não foi possível verificar o status da rodada.</p></div>`; }
        }

        function initializeQuizR1() {
            const steps = round1View.querySelectorAll('.activity-step');
            const prevBtn = round1View.querySelector('#prev-btn');
            const nextBtn = round1View.querySelector('#next-btn');
            const submitBtn = round1View.querySelector('#submit-btn');
            const progressBar = round1View.querySelector('#progress-bar');
            const progressText = round1View.querySelector('#progress-text');
            let currentStep = 1; const totalSteps = steps.length;
            function updateButtons() { prevBtn.disabled = currentStep === 1; nextBtn.style.display = currentStep === totalSteps ? 'none' : 'inline-block'; submitBtn.style.display = currentStep === totalSteps ? 'inline-block' : 'none'; }
            function showStep(stepNumber) { steps.forEach(step => step.classList.remove('active')); document.getElementById(`step-${stepNumber}`).classList.add('active'); progressBar.style.width = `${(stepNumber / totalSteps) * 100}%`; progressText.textContent = `Etapa ${stepNumber} de ${totalSteps}`; updateButtons(); }
            nextBtn.addEventListener('click', () => { if (currentStep < totalSteps) { currentStep++; showStep(currentStep); } });
            prevBtn.addEventListener('click', () => { if (currentStep > 1) { currentStep--; showStep(currentStep); } });
            showStep(currentStep);
            round1View.querySelector('#round1-form').addEventListener('submit', handleR1Submit);
        }

        async function handleR1Submit(e) {
            e.preventDefault();
            const user = auth.currentUser; if (!user) return;
            const userAnswers = {}; const formData = new FormData(e.target);
            for (const [key, value] of formData.entries()) { userAnswers[key] = value; }
            let score = 0; const totalObjective = 10;
            if(userAnswers.q1 === answerKeyR1.q1) score++; if(userAnswers.q2 === answerKeyR1.q2) score++; if(userAnswers.q3 === answerKeyR1.q3) score++;
            let matchScore = 0; for(let i=1; i<=5; i++){ if(userAnswers[`q_match_${i}`] === answerKeyR1[`q_match_${i}`]) matchScore++; } if(matchScore === 5) score++;
            let vfScore = 0; if(userAnswers.q_vf_1 === answerKeyR1.q_vf_1) vfScore++; if(userAnswers.q_vf_2 === answerKeyR1.q_vf_2) vfScore++; score += vfScore;
            const pontuacao = { acertos: score, total: totalObjective };
            round1View.style.display = 'none';
            displayResults(userAnswers, pontuacao);
            try { await setDoc(doc(db, "respostas_rodadas", `rodada1_${user.uid}`), { alunoId: user.uid, rodada: 1, respostas: userAnswers, pontuacao: pontuacao, enviadoEm: serverTimestamp() }); }
            catch (error) { console.error("Erro ao salvar respostas: ", error); }
        }

        function displayResults(userAnswers, pontuacao) {
            // Lógica para formatar e exibir os resultados...
            resultsView.style.display = 'block';
        }

        function initializeRound2() {
            const form = document.getElementById('round-2-form');
            const inputs = form.querySelectorAll('input[type="number"]');
            const totalRecursosEl = document.getElementById('total-recursos');
            const totalAlocadoEl = document.getElementById('total-alocado');
            const saldoAlocarEl = document.getElementById('saldo-alocar');
            const submitBtn = document.getElementById('r2-submit-btn');
            const capitalSocial = 480000;
            const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            function calculateBalance() {
                let emprestimo = parseFloat(document.getElementById('r2-emprestimo').value) || 0;
                let totalRecursos = capitalSocial + emprestimo;
                let totalAlocado = 0;
                inputs.forEach(input => { if(input.id !== 'r2-emprestimo') totalAlocado += parseFloat(input.value) || 0; });
                let saldo = totalRecursos - totalAlocado;
                totalRecursosEl.textContent = formatCurrency(totalRecursos);
                totalAlocadoEl.textContent = formatCurrency(totalAlocado);
                saldoAlocarEl.textContent = formatCurrency(saldo);
                if (saldo === 0 && totalAlocado > 0) { saldoAlocarEl.className = 'balanced'; submitBtn.disabled = false; }
                else { saldoAlocarEl.className = 'unbalanced'; submitBtn.disabled = true; }
            }
            inputs.forEach(input => input.addEventListener('input', calculateBalance));
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                alert('Funcionalidade de salvar Rodada 2 a ser implementada.');
            });
            calculateBalance(); // Calcula uma vez no início
        }
    </script>
</body>
</html>