<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciando Rodada...</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f7f6; }
        .loading-container { text-align: center; }
        .loading-container h1 { color: #0056b3; }
        .loading-container p { color: #333; }
    </style>
</head>
<body>

    <div class="loading-container">
        <h1>InovaPlas</h1>
        <p>Aguarde, estamos preparando sua próxima rodada...</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // SUA CONFIGURAÇÃO DO FIREBASE VAI AQUI
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Mapeamento de rodadas para as páginas correspondentes
        // ATENÇÃO: Ajuste os nomes dos arquivos .html para corresponder aos seus.
        const rodadaPaginas = {
            1: 'biblioteca.html', // Rodada 1 - Nivelamento
            2: 'perfil-investidor.html', // Rodada 2 - Fundação
            3: 'roleta.html',       // Rodada 3 - Roleta
            // Adicione as próximas rodadas aqui
            // 4: 'rodada_4.html',
            // 5: 'rodada_5.html'
        };

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const userDoc = await db.collection('usuarios').doc(user.uid).get();
                    if (!userDoc.exists) {
                        throw new Error("Usuário não encontrado no Firestore. Redirecionando...");
                    }

                    const userData = userDoc.data();
                    const alunoRodada = userData.rodadaAtual || 1; // Garante que o aluno comece na 1
                    const turmaId = userData.turmaId;

                    if (!turmaId) {
                        // Se o aluno não tem turma, não pode jogar. Vai para a experience.
                        alert("Você ainda não está em uma turma. Insira o código para começar.");
                        window.location.href = 'xperience.html';
                        return;
                    }

                    const turmaDoc = await db.collection('turmas').doc(turmaId).get();
                    if (!turmaDoc.exists) {
                        throw new Error("Turma não encontrada. Contate seu professor.");
                    }

                    const turmaData = turmaDoc.data();
                    const turmaRodadaTeto = turmaData.rodadaAtual;

                    // O aluno não pode avançar além do teto da turma
                    const rodadaParaAcessar = Math.min(alunoRodada, turmaRodadaTeto);

                    const paginaDestino = rodadaPaginas[rodadaParaAcessar];

                    if (paginaDestino) {
                        window.location.href = paginaDestino;
                    } else {
                        // Rodada ainda não implementada
                        document.body.innerHTML = `
                            <div class="loading-container">
                                <h1>Rodada ${rodadaParaAcessar} em Breve!</h1>
                                <p>O conteúdo para esta rodada ainda não está disponível. Fale com seu professor.</p>
                            </div>
                        `;
                    }

                } catch (error) {
                    console.error("Erro no roteador de rodadas: ", error);
                    alert(error.message);
                    // Em caso de erro, manda para a página de entrada
                    window.location.href = 'xperience.html';
                }
            } else {
                // Usuário não logado
                window.location.href = '../login.html';
            }
        });
    </script>

</body>
</html>