<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Aluno - Join Xperience</title>
    <style>
        :root { --cor-primaria: #0052CC; --cor-secundaria: #FF4400; --cor-sucesso: #28a745; --cor-texto: #333; --cor-fundo: #f4f7f6; --cor-branco: #fff; --cor-cinza-escuro: #343a40; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--cor-fundo); display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; width: 100%; box-sizing: border-box; }
        header.main-header { background-color: var(--cor-branco); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        header.main-header .logo-container { display: flex; align-items: center; text-decoration: none; color: var(--cor-texto); font-weight: 600; }
        header.main-header .logo-container img { height: 50px; margin-right: 15px; }
        header.main-header nav a { color: var(--cor-primaria); text-decoration: none; font-weight: 500; padding: 8px 16px; border: 1px solid var(--cor-primaria); border-radius: 8px; }
        main { flex: 1; }
        .page-header { padding: 20px; text-align: center; border-bottom: 1px solid #ddd; background-color: #e9ecef; }
        .page-header h1 { margin: 0; font-size: 2.2em; }
        .turma-status-container { padding: 25px; margin-top: 30px; border-radius: 8px; text-align: center; }
        .turma-status-container p { margin: 0 0 15px 0; font-size: 1.2em; font-weight: 600; color: var(--cor-texto); }
        #join-turma-form { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; }
        #join-turma-form input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1.1em; width: 250px; text-align: center; text-transform: uppercase; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; font-weight: 700; text-align: center; cursor: pointer; font-size: 1.1em; text-decoration: none; display: inline-block; }
        .btn-success { background-color: var(--cor-sucesso); color: var(--cor-branco); }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn:hover { opacity: 0.9; }
        .status-join { background-color: #e0f0ff; border: 1px solid #99caff; }
        .status-waiting { background-color: #fff3e0; border: 1px solid #ffcc80; }
        .status-ready { background-color: #d4edda; border: 1px solid #a5d6a7; }
        .status-ready .btn-success { font-size: 1.3em; padding: 15px 30px; }
        .status-completed { background-color: #e9ecef; border: 1px solid #ced4da; }
        .content-box { background-color: #ffffff; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-top: 30px; padding: 30px; text-align: center; }
        .content-box h2 { font-size: 1.8em; font-weight: 800; color: #333; margin-bottom: 0.5rem; }
        .xperience-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 2rem; }
        .xperience-card { background-color: #ffffff; border-radius: 1rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); text-align: left; transition: transform 0.2s ease, box-shadow 0.2s ease; border: 1px solid #e5e7eb; }
        .xperience-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
        .xperience-card a { text-decoration: none; color: inherit; display: block; padding: 1.5rem; }
        .xperience-card h4 { font-size: 1.25rem; font-weight: 600; color: #374151; margin: 0; }
        footer.main-footer { background-color: var(--cor-cinza-escuro); color: var(--cor-branco); padding: 20px; text-align: center; margin-top: auto; }
    </style>
</head>
<body>
    <header class="main-header"><a href="../index.html" class="logo-container"><img src="../JOIN.png" alt="Logo Join Xperience"><span>Join Xperience</span></a><nav><a href="#" id="logout-button">Sair</a></nav></header>
    <main class="container">
        <div class="page-header"><h1 id="welcome-title">Bem-Vindo, Aluno!</h1></div>
        <div id="turma-status-container" class="turma-status-container"><p>Verificando status da sua turma...</p></div>
        <div class="content-box">
            <h2>Recursos e Ferramentas</h2>
            <div class="xperience-grid">
                <div class="xperience-card"><a href="faq.html"><h4>Perguntas Frequentes (FAQ)</h4></a></div>
                <div class="xperience-card"><a href="perfil-investidor.html"><h4>Descubra Seu Perfil de Gestor</h4></a></div>
                <div class="xperience-card"><a href="biblioteca.html"><h4>Biblioteca de Recursos Digitais</h4></a></div>
                <div class="xperience-card"><a href="mural-explorador.html"><h4>Mural do Explorador</h4></a></div>
            </div>
        </div>
    </main>
    <footer class="main-footer"><p>© 2025 JOIN XPERIENCE - Todos os direitos reservados</p></footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, updateDoc, arrayUnion, limit } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAXtFYlnq57POCOp-b4TFuYucGlbn4NkAk", authDomain: "joinxperience-site.firebaseapp.com", projectId: "joinxperience-site", storageBucket: "joinxperience-site.appspot.com", messagingSenderId: "140037739806", appId: "1:140037739806:web:322493d72ca6149abce50f", measurementId: "G-V4SRK0FNBN" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser;
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "usuarios", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    document.getElementById('welcome-title').textContent = `Bem-Vindo, ${userDoc.data().nome}!`;
                }
                updateDashboardStatus(user);
            } else { 
                window.location.href = '../login.html'; 
            }
        });

        document.getElementById('logout-button').addEventListener('click', (e) => { e.preventDefault(); signOut(auth).then(() => { window.location.href = '../index.html'; }); });

        async function updateDashboardStatus(user) {
            const statusContainer = document.getElementById('turma-status-container');
            try {
                const turmasRef = collection(db, "turmas");
                const q = query(turmasRef, where("alunos", "array-contains", user.uid), limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    statusContainer.className = 'turma-status-container status-join';
                    statusContainer.innerHTML = `<p>Você ainda não faz parte de uma turma. Insira o código aqui!</p><form id="join-turma-form"><input type="text" id="turma-code" placeholder="Digite o código" required><button type="submit" class="btn btn-success">Entrar na Turma</button></form>`;
                    document.getElementById('join-turma-form').addEventListener('submit', handleJoinTurma);
                    return;
                }

                const turmaDoc = querySnapshot.docs[0];
                const turmaData = turmaDoc.data();
                const rodadaAtual = turmaData.rodadaAtual || 1;

                if (rodadaAtual === 1) {
                    const respostaRef = doc(db, "respostas_rodadas", `rodada1_${user.uid}`);
                    const respostaSnap = await getDoc(respostaRef);
                    if (respostaSnap.exists()) {
                        const pontuacao = respostaSnap.data().pontuacao;
                        statusContainer.className = 'turma-status-container status-completed';
                        statusContainer.innerHTML = `<p><strong>Você finalizou a Rodada 1!</strong></p><p style="font-size: 1em; font-weight: normal;">Sua pontuação de referência foi: ${pontuacao.acertos} de ${pontuacao.total}.</p><a href="rodada.html" class="btn btn-secondary">Ver Meus Resultados</a>`;
                    } else if (turmaData.statusRodada1 === 'iniciada') {
                        statusContainer.className = 'turma-status-container status-ready';
                        statusContainer.innerHTML = `<p><strong>A Rodada 1 da sua turma "${turmaData.nome}" começou!</strong></p><a href="rodada.html" class="btn btn-success">Jogar Agora!</a>`;
                    } else {
                        statusContainer.className = 'turma-status-container status-waiting';
                        statusContainer.innerHTML = `<p>Você está na turma "<strong>${turmaData.nome}</strong>". Aguardando seu professor iniciar a Rodada 1.</p>`;
                    }
                } else if (rodadaAtual === 2) {
                    const respostaRef = doc(db, "respostas_rodadas", `rodada2_${turmaDoc.id}`);
                    const respostaSnap = await getDoc(respostaRef);
                    if (respostaSnap.exists()) {
                        statusContainer.className = 'turma-status-container status-completed';
                        statusContainer.innerHTML = `<p><strong>Sua equipe finalizou a Estruturação da Empresa (Rodada 2).</strong></p><p style="font-size: 1em; font-weight: normal;">Aguarde o professor iniciar a próxima rodada.</p>`;
                    } else if (turmaData.statusRodada2 === 'iniciada') {
                         statusContainer.className = 'turma-status-container status-ready';
                        statusContainer.innerHTML = `<p><strong>A Rodada 2 da sua turma "${turmaData.nome}" começou!</strong></p><p style="font-size: 1em; font-weight: normal;">É hora de estruturar sua empresa.</p><a href="rodada.html" class="btn btn-success">Iniciar Balanço</a>`;
                    } else {
                        statusContainer.className = 'turma-status-container status-waiting';
                        statusContainer.innerHTML = `<p>Você está na turma "<strong>${turmaData.nome}</strong>". Aguardando seu professor iniciar a Rodada 2.</p>`;
                    }
                }

            } catch (error) {
                console.error("Erro ao verificar status da turma:", error);
                statusContainer.innerHTML = `<p style="color:red;">Ocorreu um erro ao carregar os dados da sua turma. Tente recarregar a página.</p>`;
            }
        }

        async function handleJoinTurma(e) {
            e.preventDefault();
            const turmaCode = document.getElementById('turma-code').value.trim().toUpperCase();
            if (!turmaCode) { alert('Por favor, digite um código.'); return; }
            const turmasRef = collection(db, "turmas");
            const q = query(turmasRef, where("codigo", "==", turmaCode));
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { alert("Código da turma inválido."); return; }
                const turmaDoc = querySnapshot.docs[0];
                if (turmaDoc.data().alunos && turmaDoc.data().alunos.includes(currentUser.uid)) { alert(`Você já faz parte desta turma!`); return; }
                await updateDoc(turmaDoc.ref, { alunos: arrayUnion(currentUser.uid) });
                alert(`Inscrição na turma "${turmaDoc.data().nome}" realizada com sucesso!`);
                updateDashboardStatus(currentUser);
            } catch (error) { console.error("Erro ao entrar na turma: ", error); alert("Ocorreu um erro ao tentar entrar na turma."); }
        }
    </script>
</body>
</html>