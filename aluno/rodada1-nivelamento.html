<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rodada 1: Nivelamento - InovaPlas</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { color: #003366; border-bottom: 2px solid #b3d1ff; padding-bottom: 10px; }
        #quiz-container p { font-size: 1.1em; line-height: 1.6; }
        fieldset { border: none; padding: 0; margin-bottom: 25px; }
        legend { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; color: #333; }
        label { display: block; background-color: #f8f9fa; padding: 12px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; border: 1px solid #ddd; }
        input[type="radio"] { margin-right: 10px; }
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Rodada 1: Nivelamento de Conhecimentos</h1>
        <div id="quiz-container">
            <p>Bem-vindo(a) à simulação InovaPlas! Antes de começar a sua jornada como gestor(a), precisamos de avaliar os seus conhecimentos iniciais. Por favor, responda às 5 perguntas abaixo.</p>
            <p id="loading-quiz">A carregar o questionário...</p>
            <form id="form-rodada1" style="display: none;">
                <div id="quiz-questions"></div>
                <button type="submit" id="submit-btn">Finalizar Nivelamento e Avançar para a Rodada 2</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAXtFYlnq57POCOp-b4TFuYucGlbn4NkAk",
            authDomain: "joinxperience-site.firebaseapp.com",
            projectId: "joinxperience-site",
            storageBucket: "joinxperience-site.appspot.com",
            messagingSenderId: "140037739806",
            appId: "1:140037739806:web:322493d72ca6149abce50f",
            measurementId: "G-V4SRK0FNBN"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const loadingQuiz = document.getElementById('loading-quiz');
        const formRodada1 = document.getElementById('form-rodada1');
        const quizQuestionsDiv = document.getElementById('quiz-questions');
        const submitBtn = document.getElementById('submit-btn');

        auth.onAuthStateChanged(user => {
            if (user) {
                montarQuiz(user);
            } else {
                alert("Sessão expirada. A redirecionar para o login.");
                window.top.location.href = '../login.html';
            }
        });

        async function montarQuiz(user) {
            try {
                const snapshot = await db.collection('banco_questoes_r1').get();
                if (snapshot.empty) throw new Error("Banco de questões não encontrado.");

                let todasAsPerguntas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Embaralha o array para garantir perguntas aleatórias
                for (let i = todasAsPerguntas.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [todasAsPerguntas[i], todasAsPerguntas[j]] = [todasAsPerguntas[j], todasAsPerguntas[i]];
                }

                const perguntasSorteadas = todasAsPerguntas.slice(0, 5);

                let quizHTML = '';
                perguntasSorteadas.forEach((pergunta, index) => {
                    quizHTML += `<fieldset><legend>${index + 1}. ${pergunta.enunciado}</legend>`;
                    if (pergunta.opcoes && pergunta.opcoes.length > 0) {
                        pergunta.opcoes.forEach((opcao, i) => {
                            const optionId = `q${index}_opt${i}`;
                            quizHTML += `<div><label for="${optionId}"><input type="radio" id="${optionId}" name="pergunta_${index}" value="${i}" required> ${opcao}</label></div>`;
                        });
                    }
                    quizHTML += `</fieldset>`;
                });

                quizQuestionsDiv.innerHTML = quizHTML;
                loadingQuiz.style.display = 'none';
                formRodada1.style.display = 'block';

            } catch (error) {
                console.error("Erro ao montar o quiz:", error);
                loadingQuiz.textContent = "Ocorreu um erro ao carregar o questionário. Verifique se a coleção 'banco_questoes_r1' existe.";
                loadingQuiz.style.color = 'red';
            }
        }

        formRodada1.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = "A guardar o seu progresso...";

            try {
                const user = auth.currentUser;
                if (user) {
                    const userRef = db.collection('usuarios').doc(user.uid);
                    await userRef.update({ rodadaAtual: 2 }); // Avança o aluno para a rodada 2

                    alert("Nivelamento concluído com sucesso! Será agora redirecionado.");
                    window.top.location.href = 'rodada.html'; // Volta para o roteador para ir para a próxima rodada
                }
            } catch (error) {
                 console.error("Erro ao finalizar a rodada 1:", error);
                 alert("Ocorreu um erro ao guardar o seu progresso. Tente novamente.");
                 submitBtn.disabled = false;
                 submitBtn.textContent = "Finalizar Nivelamento e Avançar para a Rodada 2";
            }
        });

    </script>
</body>
</html>
